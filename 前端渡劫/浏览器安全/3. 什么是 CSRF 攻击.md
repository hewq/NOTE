**CSRF（Cross-Site Request Forgery）跨站请求伪造**是一种常见的 Web 安全攻击。它利用受害者已登录的身份，在用户不知情的情况下冒充用户对网站发起恶意请求，从而执行未经授权的操作。

------

## **CSRF 攻击的原理**

CSRF 攻击的关键是攻击者通过伪造请求，利用用户的身份认证信息（如 Cookie 或 Session），让目标网站错误地认为该请求是用户主动发起的。

### 攻击流程：

1. **用户登录可信网站A**：用户登录到网站A（比如银行网站）并生成了一个有效的认证凭证（如 Session 或 Cookie）。

2. **用户访问恶意网站B**：用户在登录状态下访问了攻击者控制的网站B。

3. 攻击者构造恶意请求

   ：恶意网站B包含一个指向网站A的请求，利用用户的登录状态，伪造请求发送到网站A。 

   - 例如转账请求： 

     ```html
     <img src="https://bank.com/transfer?to=attacker&amount=1000" />
     ```

4. **网站A信任用户的身份**：由于网站A没有验证请求的来源，使用了用户的 Cookie 或 Session，误以为这是合法请求。

5. **攻击成功**：攻击者的恶意请求被成功执行（如资金转账）。

------

## **CSRF 攻击的特点**

- 利用受害者的身份和权限，而非直接攻击网站。
- 通常不需要窃取用户的登录凭证（如密码或 Token）。
- 依赖用户的登录状态，攻击通常发生在用户已登录目标网站的情况下。

------

## **CSRF 的危害**

- **伪造操作**：例如转账、修改账户信息、删除数据。
- **隐私泄露**：攻击者可以通过恶意请求访问用户隐私数据。
- **业务逻辑攻击**：针对特定业务流程进行恶意利用。

------

## **如何防御 CSRF 攻击**

1. **验证请求来源**

   - 检查 HTTP 请求头中的 `Referer` 或 `Origin`。
   - 确保请求来自可信来源。
   - 局限：可能被伪造或在某些情况下不存在。

2. **CSRF Token**

   - 在表单中嵌入一个随机生成的 Token，提交请求时携带该 Token。

   - 服务器验证 Token 是否匹配，确保请求的合法性。

   - 示例： 

     ```html
     <input type="hidden" name="csrf_token" value="random_token_value">
     ```

   - 服务端在每次请求时检查 `csrf_token` 的有效性。

3. **双重 Cookie 验证**

   - 将 CSRF Token 存储在用户的 Cookie 中，用户发起请求时在自定义请求头中发送 Token。
   - 服务端验证 Cookie 中的 Token 和请求头中的 Token 是否一致。

   示例：

   ```javascript
   const csrfToken = getCookie('csrfToken');
   fetch('/action', {
     method: 'POST',
     headers: { 'X-CSRF-Token': csrfToken },
     body: JSON.stringify(data),
   });
   ```

4. **限制请求方法**

   - 对敏感操作只允许 `POST`、`PUT`、`DELETE` 等方法。
   - 拒绝 `GET` 方法发起的修改操作，避免通过 `<img>`、`<a>` 等标签伪造请求。

5. **设置 SameSite Cookie 属性**

   - 限制 Cookie 的跨站发送：

     - `SameSite=Strict`：Cookie 仅在同站点请求中发送。
     - `SameSite=Lax`：Cookie 在某些跨站请求中可发送（如 GET 方法）。
     - `SameSite=None; Secure`：允许跨站发送，但必须在 HTTPS 下。

     示例：

     ```http
     Set-Cookie: sessionId=abc123; SameSite=Strict;
     ```

6. **验证码**

   - 在关键操作中引入人机验证（如 CAPTCHA），防止自动化伪造请求。

7. **提高用户警惕**

   - 告知用户不要点击未知来源的链接。
   - 避免在敏感操作时保持登录状态。

------

## **CSRF 与 XSS 的区别**

| **特性**         | **CSRF**                               | **XSS**                                |
| ---------------- | -------------------------------------- | -------------------------------------- |
| **攻击目标**     | 利用用户身份发起恶意请求               | 注入恶意代码并在受害者浏览器中执行     |
| **依赖用户输入** | 不需要用户直接输入恶意内容             | 需要用户输入恶意代码                   |
| **影响范围**     | 操作目标网站的资源（如转账、修改数据） | 窃取用户信息、劫持会话、冒充用户行为   |
| **防御方式**     | CSRF Token、SameSite Cookie            | 输入验证、输出转义、内容安全策略 (CSP) |

------

通过正确实施 CSRF 防御措施，可以大幅降低应用程序受攻击的风险。